# 프로세스 동기화
## 등장 배경
* 프로세스는 명령엉가 실행될때 어느 지점에서나 인터럽트 되고 , 처리 코어는 다른 프로세스의 명령어를 실행하도록 힐당한다. 또한 병렬 실행 즉 다른 프로세스에 속한 두개의 명령어 흐름이 한순간에 다른 처리 코어에서 동시에 실행되는 방식을 소개한다.     
병행또는 병렬 실행될때 여러 프로세스가 공유하는 데이터의 무결성에 어떤 문제를 일으키는지에 대해 설명 하고 있다.     
동시에 여러개의 프로세스가 동일한 자료를 접근하여 조작하고 그 실행 결과가 접근 이 발행한 특정 순서에 의존하는 상황인 **경쟁 상황(Race Condition)**이라고 한다. 위와 같은 상황으로 부터 보호하기 위해 한순간에 하나의 프로세스만이 변수 Counter르 조작하고록 보장 해야한다. 이러한 보장을 위해 어떤 형태로든 프로세스들이 동기화 되도록 할 필요가 있다.      
운영체제의 여러부분에서 자원을 조작 하기 때문에 위와 같은 상황은 빈번하게 발생한다. 다중 코어 시스템의 성장과 더불어 다중 스레드 응용의 개발에 관한 관심이 증가하고 이러한 다중 스레드 응용에서는 자원을 공유할 가능성이 매우 높은 여러 스레드가 서로 다른 처리코어에서 병렬로 실행된다.     
서로간에 영향을 주지 않기를 원하며 이문제는 협력하느 프로세스들간의 프로세스 동기화 조정에 할애된다.    
## 임계 구역 문제(The Critical Section Problem)
* 프로세스 동기화 에 관한 논의는 임계 구역 문제하고 불리는 문제로부터 시작한다.    
    n개의 프로세스 {p0 ~ pn-1}이 있는 시스템을 고려해보면 각 프로세스는 임계 구역이라는 부르는 코드 부분을 포함하고 있고 , 그 안에서는 다른 프로세스와 공유하는 변수를 변경하거나 테이블을 갱신하거나 파일을 관련 작업을 수행한다.     
    **이 시스템의 중요한 특징은 "한 프로세스가 자신의 임계 구역에서 수행하는 동안에는 다른 프로세스들은 그들의 임계구역에 들어 갈 수 없다"!!**    
    임계구역 문제는 프로세스들이 협력할 때 사용할 수 있는 프로토콜을 설계하는 것이며 각 프로세스는 자신의 임계 구역으로 진입허가를 요청해야한다.    
    이러한 요청을 구현하는 코드 부분을 **진입 구역** 이라고 한다. 임계 구역뒤에는 퇴출 구역이 따라온다. 코드의 나머지 부분들은 총칭하여 **나머지 구역**이라고 한다.      
    임계 구역 문제에 대한 해결안은 다음의 세가지 요구 조건 존재   
    1. 상호 배제(mutual exculsion) : 프로세슷 PI가 자신의 임계 구역애서 실행된다면 다른 프로세스들은 그들 자신의 임계구역에서 실행될 수 있다.
    2. 진행(progress) : 자기 임계구역에서 실행된느 프로세스가 없고 그리고 그들 자신의 임계 구역으로 진입하려고 하는 프로세스들이 있다면 나머지 구역에서 실행 중이지 않은 프로세스들만 다음에 누가 그 임계 구역으로 진입 할 수 있는지를 결점하는데 참여할 수 있으며 이선택은 무한정 연기 될 수 없다.     
    3. 한정된 대기(bounded waiting) : 프로세스가 자기의 입계 구역에 진입하려는 요청을 한 후분터 그 요청이 허용될때까지 다른 프로세스들이 그들 자신의 임계 구역에 진입하도록 허용되는 횟수에 한계가 있어야한다.
* 운영체제 내에서 임계 구역을 다루기 위해 선점형 , 비선점형 커널의 두가지 일반적인 접근법이 사용된다. 선점형 커널은 프로세슷가 커널모드에서 수행되는 동안 선점되는 것을 허용한다. 비선점형 커널은 커널 모드에서 수행는 프로세스의 선점을 허용하지 않고 커널 모드 프로세스는 커널을 빠져나갈때 까지 또는 봉쇄 될때까지 또는 자발적으로 CPU의 제어를 양보할 때 까지 계속 수행된다.    
* 비선점형 커널은 한순간에 커널안에서는 실행 중 인 프로세스는 하나 밖에 없기 때문에 커널 자료 구조에 대한 경쟁 조건을 염려할 필요없다    
선점형 커널은 공유된느 커널 자료구조에서 경쟁 조건이 발생하지 않는 다는 것을 고려하여 신중하게 설계 되어야한다.**커널 모드 프로세스가 대기중인 프로세스에게 처리기를 양도하기전에 오랫동안 실행할 위험이 적기 때문에 선점형 커널은 응답이 더 민첩할 수 있다**
## 피터슨 해결안
* 고전적인 소프트웨어 기반 해결책이며 현대 컴퓨터 구조에서 잘맞다고는 할 수 없지만 상호 배제, 진행 , 한정된 대기의 요구조건을 만족 할 수 있다.     
피터슨 해결안은 임계 구역과 나머지 구역을 번갈아 가며 실행하는 두개의 프로세스가 한정된다.두 프로세스가 두개의 데이터를 공유하도록 하여 해결한다.     
1. 상호 배제가 제대로 지켜진다는 사실
2. 진행에 대한 요구 조건을 만족한다는 사실
3. 대기 시간이 한없이 길어지지 않느 다는 사실
## Muutex Lock
* 임계 구역 문제에 대한 하드웨어 기반 해결책은 복잡하며 응용 프로그래머는 사용할 수 없다.대신 가장 간단한 방법으로는 Mutext락 Library를 사용하는것이다.    
우리는 임계 구역을 보호하고 따라서 경쟁 조건을 방지하기 위해 mutex 락을 사용한다.     
즉 프로세스는 임계 구역에 들어가기전에 반드시 락을 획득해야 하고 나올떄 락을 반환 해야한다. mutex락은 available이라는 불린 변수 가집니다. 이 변수 값의 락의 가용 여부를 표시합니다. 락이 가용하면 acquire()호출은 성공하고 락은 곧 사용 불가 상태가 됩니다. 사용 불가 상태의 락은 획득하려고 시도하는 프로세스는 락이 반환될때까지 봉쇄한다.
* 구현 방식의 단점은 바쁜대기를 해야한다는 점입니다. 프로세스 임계구역에 있는 동안 임계 구역에 들어가기 원하는 다른 프ㄴ로세스들은 acquire() 함수를 호출하는 반복문을 계속 실행해야한다. 사실 이러한 유형의 mutex락은 락이 가용해지기를 기다리면서 프로세스가 계속 회전을 하고 있기 때문에 spinlock이라고 부른다.       
**[mutex 사용할 라이브러리](https://modoocode.com/270)**
## 세미포(Semphores)
* 유래 : 기찻길에서 깃발 표식으로 파란색이 걸려있으면 섰다가 지나가도 되고 빨간색이 걸려있으면 섰다가 지나가면 지나가게끔 하는 용도로 깃발을 사용하는데 깃발을 **semphore**라고한다.     
기찻길중 겹치는 부분을 critical section이라고 하며 실질적으로 semaphrore는 shared Data의 개수를 의미한다.     
* **공유 자원의 개수를 나타내는 변수이다!!**
### 참고 자료
* **[참고 자료_1](https://parksb.github.io/article/10.html)**
* **[참고 자료_2](https://ggodong.tistory.com/96?category=793310)**

## PerterSon Solution
* PerterSon Solution으로 임계 영역 문제를 해결 할 수 있다.
임계 영역에건 프로세스가 작업중인지 저장하는 변수 flag와 critical sectiond에 진입하고자 하는 프로세스를 가리키는 변수 turn을 만들어 어떤 프로세스가 임계 영역에 진입하면 flag를 lock하고 나오면 , unlock하는 방식으로 임계 영역 문제를 해결한다.

```
do
{
	flag[i] = true;
	turn = j;
	while(flag[j] && turn == j )
//Critical Section 
flag[i] = false;
//Remainder Section
}
while(true);
```
## Mutex Locks(MUTual EXclusion을 줄인 말이다.)
* Mutex Lock은 여러 스레드가 공통 리소스에 접근하는 것을 제어하는 기법으로 lock이 하나만 존재할 수 있는 locking 매커니즘을 따른다.이미 하나의 스레드가 critical section에서 작업중인 lock 상태에서 다른 스레드들은 critical section에 진입할 수 없도록 한다.

##Semphores
* 세마포어(Semphore)는 여러 개의 프로세스나 스레드가 critical section에 진입 할 수 있는 locking 매커니즘이다. 세마포어는 카운터를 이용해 동시에 리소스에 접근 할 수 있는 프로세스를 제한한다. 물론 한 프로세스가 값을 변경할 때 다른 프로세스가 변경할 떼 다른 프로세스가 동시에 값을 변경하지는 못한다.

##Sempahore Usage
* 세미포어의 카운터가 한 개인 경우 바이너리 세마포어(Binary Semphore)두개의 이상인 카운팅 세마포어(Counting semphore)라고 한다. 바이너리 세마포어는 사실상 mutex와 같다.

## Deadlocks and Starvation
두 프로세스가 서로 종료 될 때가지 대기하는 프로그램을 생각해보자 .프로세스 A는 B가 종료될 때까지, 프로세스 B는 A가 종료될 때까지 작업 하지 않기 때문에 프로그램은 어떤 동작도 하지 못할 것이다. 두 프로세스가 리소스를 점유하고 놓아주지 않거나 . 어떠한 프로세스도 리소스를 점유하지 못하는 상태가 되어 프로그램이 멈추는 현상을 데드락이라고 한다.

